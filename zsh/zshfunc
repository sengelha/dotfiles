# zshfunc
#
# ZSH functions.  Note that returning 0 is success and nonzero is failure.

# Is the function executable?
isexec() {
  typeset exe="$1"

  if [ x$exe = x ]; then
    return 1
  fi

  if ! which $exe > /dev/null 2>&1; then
    return 1
  fi

  return 0
}

# Does a process with the given pid exist?
process_with_pid_exists() {
  typeset pid="$1"

  if [[ -n $pid ]]; then
    [[ -d /proc/$pid ]] && return 0

    typeset ps_list="`(ps auxwww | awk '{print $2}') 2> /dev/null`"
    if [[ -n $ps_list ]]; then
      if echo $ps_list | grep $pid > /dev/null; then
        return 0
      else
        return 1
      fi
    fi
  fi

  echo "ERROR: Cannot determine if process "$pid" exists!" 1>&2
  return 2
}

ssh_start_agent() {
  ssh-agent >! ~/.ssh/ssh-agent.out
  eval `cat ~/.ssh/ssh-agent.out` > /dev/null
}

ssh_add_keys() {
  # Sets $?: 0 = exists, 1 = does not exist, 2 = error
  process_with_pid_exists $SSH_AGENT_PID

  if [[ $? -eq 0 ]]; then
    if ! ssh-add -l > /dev/null; then
      ssh_add_args=()
      for f in $HOME/.ssh/identity $HOME/.ssh/id_dsa $HOME/.ssh/id_rsa; do
        if [[ -r ${f} ]]; then
          ssh_add_args[$((${#ssh_add_args} + 1))]=$f
        fi
      done
      ssh-add ${ssh_add_args[@]}
    fi
  else
    echo "ssh_add_keys: not able to find process with pid $SSH_AGENT_PID" 1>&2
  fi
}

ssh_start() {
  if [[ -x `which ssh-agent` && -x `which ssh-add` ]]; then
    if [[ -r .ssh/identity || -r .ssh/id_dsa || -r .ssh/id_rsa ]]; then
      if [[ -r .ssh/ssh-agent.out ]]; then
        eval `cat .ssh/ssh-agent.out` > /dev/null
 
        if [[ -n $SSH_AGENT_PID ]]; then
          # Sets $?: 0 = exists, 1 = does not exist, 2 = error
          process_with_pid_exists $SSH_AGENT_PID
      
          if [[ $? -eq 1 ]]; then
            unset SSH_AUTH_SOCK
            unset SSH_AGENT_PID
            rm -f .ssh/ssh-agent.out

            ssh_start_agent
          fi
        else # SSH_AGENT_PID not set by ssh-agent.out, weird
          ssh_start_agent
        fi
      else # ssh-agent.out is not readable
        ssh_start_agent
      fi

      ssh_add_keys
    fi
  fi
}

run_kinit() {
  # Call kinit if need tickets and they are expired/unavailable.  Renew them
  # automatically otherwise.
  if [[ -r .fetchmailrc ]]; then
    if grep -i "proto kpop" .fetchmailrc > /dev/null 2>&1; then
      if isexec klist && isexec kinit; then
        if ! klist 1> /dev/null 2>&1; then
          echo -n "kinit: "
          kinit -l 90000 --renewable
        elif klist | grep -i "expired" > /dev/null 2>&1; then
          echo -n "kinit: "
          kinit -l 90000 --renewable
        else
          kinit -R
        fi
      fi
    fi
  fi
}

run_fortune() {
  if isexec fortune; then
    if [[ -r /usr/share/games/fortune/fortunes-o ]]; then
      fortune -a
    else
      fortune
    fi
  fi
}

setenv() { export $1=$2 }  # csh compatibility
